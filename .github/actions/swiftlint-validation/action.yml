name: 'SwiftLint Validation'
description: 'Standardized SwiftLint validation with caching, installation, and detailed reporting'
author: 'usbipd-mac CI Team'

inputs:
  strict-mode:
    description: 'Enable strict mode (treat warnings as errors)'
    required: false
    default: 'true'
  cache-key-suffix:
    description: 'Additional cache key suffix for cache differentiation'
    required: false
    default: ''
  working-directory:
    description: 'Working directory for SwiftLint execution'
    required: false
    default: '.'
  reporter:
    description: 'SwiftLint reporter format (xcode, json, csv, checkstyle, junit, html, emoji, sonarqube, markdown)'
    required: false
    default: 'xcode'

outputs:
  result:
    description: 'SwiftLint validation result (success, failed, error)'
    value: ${{ steps.validate.outputs.result }}
  violations-count:
    description: 'Number of violations found'
    value: ${{ steps.validate.outputs.violations_count }}
  cache-hit:
    description: 'Whether SwiftLint was restored from cache'
    value: ${{ steps.cache-swiftlint.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ“‹ Starting SwiftLint Validation
      shell: bash
      run: |
        echo "::notice title=SwiftLint Validation::Starting standardized SwiftLint code quality validation"
        echo "ğŸ” Validating Swift code against project style guidelines"
        echo "ğŸ“Š Status: STARTING"
        echo "âš™ï¸ Working directory: ${{ inputs.working-directory }}"
        echo "ğŸ¯ Strict mode: ${{ inputs.strict-mode }}"
        echo "ğŸ“‹ Reporter format: ${{ inputs.reporter }}"

    - name: Cache SwiftLint Installation
      id: cache-swiftlint
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/bin/swiftlint
          /opt/homebrew/bin/swiftlint
        key: ${{ runner.os }}-swiftlint-${{ hashFiles(format('{0}/.swiftlint.yml', inputs.working-directory)) }}-v2${{ inputs.cache-key-suffix }}
        restore-keys: |
          ${{ runner.os }}-swiftlint-v2${{ inputs.cache-key-suffix }}
          ${{ runner.os }}-swiftlint-v2
          ${{ runner.os }}-swiftlint-

    - name: ğŸ”§ Install SwiftLint
      shell: bash
      run: |
        echo "::group::SwiftLint Installation"
        echo "ğŸ“¦ Checking SwiftLint installation status..."
        
        # Check if SwiftLint is already installed and functional
        if command -v swiftlint &> /dev/null && swiftlint version &> /dev/null; then
          echo "::notice title=SwiftLint Found::Using cached SwiftLint installation"
          echo "âœ… SwiftLint is already installed and functional"
          echo "ğŸ“‹ Version: $(swiftlint version)"
          echo "ğŸ’¾ Cache status: ${{ steps.cache-swiftlint.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        else
          echo "::notice title=SwiftLint Installation::Installing SwiftLint via Homebrew"
          echo "â¬‡ï¸ SwiftLint not found or non-functional, installing via Homebrew..."
          
          # Install SwiftLint with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if brew install swiftlint; then
              echo "âœ… SwiftLint installation completed successfully"
              echo "ğŸ“‹ Installed version: $(swiftlint version)"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Installation attempt $RETRY_COUNT failed, retrying..."
                sleep 5
              else
                echo "::error title=Installation Failed::SwiftLint installation failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
        fi
        echo "::endgroup::"

    - name: ğŸ“ SwiftLint Configuration Validation
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "::group::Configuration Validation"
        echo "::notice title=Configuration Check::Validating SwiftLint configuration"
        
        # Check for SwiftLint configuration file
        if [ -f ".swiftlint.yml" ]; then
          echo "âœ… SwiftLint configuration found: .swiftlint.yml"
          
          # Validate configuration syntax
          if swiftlint rules &> /dev/null; then
            echo "âœ… Configuration syntax valid"
            
            # Show enabled rules count for transparency
            RULES_COUNT=$(swiftlint rules | wc -l)
            echo "ğŸ“‹ Active rules: $RULES_COUNT"
          else
            echo "::warning title=Configuration Warning::SwiftLint configuration may have issues"
            echo "âš ï¸ Configuration validation had warnings, but proceeding with default rules"
          fi
        else
          echo "::notice title=Default Configuration::Using SwiftLint default configuration"
          echo "ğŸ“‹ No .swiftlint.yml found, using default rules"
        fi
        echo "::endgroup::"

    - name: ğŸ” Execute SwiftLint Analysis
      id: validate
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "::group::SwiftLint Analysis"
        echo "::notice title=Code Analysis::Running SwiftLint with standardized validation"
        echo "ğŸ” Analyzing Swift code for style and quality violations..."
        echo "ğŸ“Š Status: RUNNING"
        echo "âš™ï¸ Configuration: Using project SwiftLint rules"
        echo "ğŸ¯ Mode: ${{ inputs.strict-mode == 'true' && 'Strict (warnings as errors)' || 'Standard' }}"
        echo "ğŸ“‹ Reporter: ${{ inputs.reporter }}"
        
        # Prepare SwiftLint command
        SWIFTLINT_CMD="swiftlint lint --reporter ${{ inputs.reporter }}"
        if [ "${{ inputs.strict-mode }}" == "true" ]; then
          SWIFTLINT_CMD="$SWIFTLINT_CMD --strict"
        fi
        
        # Execute SwiftLint and capture results
        VIOLATIONS_COUNT=0
        RESULT="success"
        
        echo "ğŸš€ Executing: $SWIFTLINT_CMD"
        
        # Run SwiftLint and capture both exit code and output
        if OUTPUT=$($SWIFTLINT_CMD 2>&1); then
          echo "::notice title=SwiftLint Success::No code style violations found"
          echo "âœ… Code quality validation PASSED"
          echo "ğŸ“Š Status: SUCCESS"
          RESULT="success"
          
          # Try to extract violations count from output (if available)
          if echo "$OUTPUT" | grep -q "violations"; then
            VIOLATIONS_COUNT=$(echo "$OUTPUT" | grep -o '[0-9]\+ violations' | grep -o '[0-9]\+' | head -1 || echo "0")
          fi
        else
          SWIFTLINT_EXIT_CODE=$?
          echo "::error title=SwiftLint Violations::Code style violations detected"
          echo "âŒ Code quality validation FAILED"
          echo "ğŸ“Š Status: FAILED"
          echo "ğŸ”§ Exit code: $SWIFTLINT_EXIT_CODE"
          RESULT="failed"
          
          # Extract violations count for reporting
          if echo "$OUTPUT" | grep -q "violations"; then
            VIOLATIONS_COUNT=$(echo "$OUTPUT" | grep -o '[0-9]\+ violations' | grep -o '[0-9]\+' | head -1 || echo "unknown")
          else
            VIOLATIONS_COUNT="unknown"
          fi
          
          # Show detailed output for debugging
          echo "ğŸ“‹ SwiftLint output:"
          echo "$OUTPUT"
        fi
        
        # Set outputs for downstream use
        echo "result=$RESULT" >> $GITHUB_OUTPUT
        echo "violations_count=$VIOLATIONS_COUNT" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Final status: $RESULT"
        echo "ğŸ”¢ Violations found: $VIOLATIONS_COUNT"
        echo "::endgroup::"
        
        # Exit with failure if violations found and strict mode enabled
        if [ "$RESULT" == "failed" ]; then
          exit 1
        fi

    - name: ğŸ“Š SwiftLint Validation Summary
      shell: bash
      if: always()
      run: |
        echo "::group::SwiftLint Validation Summary"
        
        RESULT="${{ steps.validate.outputs.result }}"
        VIOLATIONS_COUNT="${{ steps.validate.outputs.violations_count }}"
        CACHE_STATUS="${{ steps.cache-swiftlint.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        
        if [ "$RESULT" == "success" ]; then
          echo "::notice title=Validation Complete::SwiftLint validation completed successfully"
          echo "âœ… SwiftLint validation: PASSED"
          echo "ğŸ“‹ Code quality: EXCELLENT"
          echo "ğŸ¯ No style violations detected"
          echo "ğŸ’¾ Cache performance: $CACHE_STATUS"
        else
          echo "::error title=Validation Failed::SwiftLint validation detected violations"
          echo "âŒ SwiftLint validation: FAILED"
          echo "ğŸ“‹ Violations found: $VIOLATIONS_COUNT"
          echo "ğŸ”§ Action required: Fix code style issues before merging"
          echo "ğŸ’¾ Cache performance: $CACHE_STATUS"
          echo ""
          echo "ğŸ“– Common SwiftLint violation resolution tips:"
          echo "   â€¢ Run 'swiftlint --fix' for auto-fixable violations"
          echo "   â€¢ Check .swiftlint.yml for project-specific rules"
          echo "   â€¢ Use 'swiftlint lint' locally before committing"
          echo "   â€¢ Review SwiftLint documentation for style guidelines"
        fi
        
        echo "::endgroup::"
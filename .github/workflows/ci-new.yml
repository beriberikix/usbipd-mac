name: CI (Consolidated)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # Support release tag validation
  pull_request:
    branches: [ main ]
  workflow_call:  # Enable reuse by release workflows
    inputs:
      release_validation:
        description: 'Enable release-specific validation steps'
        required: false
        default: false
        type: boolean
      skip_optional_tests:
        description: 'Skip optional integration tests for faster release validation'
        required: false
        default: false
        type: boolean
      test_environment:
        description: 'Test environment to run (development, ci, production)'
        required: false
        default: 'ci'
        type: string
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test environment to run'
        required: false
        default: 'ci'
        type: choice
        options:
          - development
          - ci
          - production
      enable_qemu_tests:
        description: 'Enable QEMU integration tests'
        required: false
        default: false
        type: boolean
      enable_hardware_tests:
        description: 'Enable hardware-dependent tests'
        required: false
        default: false
        type: boolean
      release_validation:
        description: 'Enable release-specific validation steps'
        required: false
        default: false
        type: boolean

env:
  # Global environment variables for consistent status reporting
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Release validation context
  IS_RELEASE_VALIDATION: ${{ inputs.release_validation || contains(github.ref, 'refs/tags/') }}
  SKIP_OPTIONAL_TESTS: ${{ inputs.skip_optional_tests || false }}
  TEST_ENVIRONMENT: ${{ inputs.test_environment || 'ci' }}

jobs:
  code-quality:
    name: Code Quality
    runs-on: macos-latest
    outputs:
      result: ${{ steps.swiftlint.outputs.result }}
      violations-count: ${{ steps.swiftlint.outputs.violations-count }}
    steps:
      - name: ğŸ“‹ Starting Code Quality Validation
        run: |
          echo "::notice title=Code Quality::Starting comprehensive code quality validation"
          echo "ğŸ” Validating Swift code against project style guidelines using standardized SwiftLint validation"
          echo "ğŸ“Š Status: STARTING"
          echo "ğŸ¯ Using reusable composite action for consistent validation"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run SwiftLint Validation
        id: swiftlint
        uses: ./.github/actions/swiftlint-validation
        with:
          strict-mode: 'true'
          cache-key-suffix: '-ci'
          working-directory: '.'
          reporter: 'xcode'

      - name: ğŸ“Š Code Quality Summary
        if: always()
        run: |
          echo "::group::Code Quality Summary"
          
          RESULT="${{ steps.swiftlint.outputs.result }}"
          VIOLATIONS_COUNT="${{ steps.swiftlint.outputs.violations-count }}"
          
          if [ "$RESULT" == "success" ]; then
            echo "::notice title=Quality Complete::Code quality validation completed successfully"
            echo "âœ… SwiftLint validation: PASSED"
            echo "ğŸ“‹ Code quality: EXCELLENT"
            echo "ğŸ¯ No style violations detected"
          else
            echo "::error title=Quality Failed::Code quality validation detected violations"
            echo "âŒ SwiftLint validation: FAILED"
            echo "ğŸ“‹ Violations found: $VIOLATIONS_COUNT"
            echo "ğŸ”§ Action required: Fix code style issues before merging"
          fi
          
          echo "::endgroup::"

  build-validation:
    name: Build Validation
    runs-on: macos-latest
    outputs:
      swift-version: ${{ steps.swift-setup.outputs.swift-version }}
      cache-hit: ${{ steps.swift-setup.outputs.cache-hit }}
    steps:
      - name: ğŸ—ï¸ Starting Build Validation
        run: |
          echo "::notice title=Build Validation::Starting comprehensive project build validation"
          echo "ğŸ”¨ Validating that the project compiles successfully with comprehensive dependency resolution"
          echo "ğŸ“Š Status: STARTING"
          echo "ğŸ¯ Using reusable composite action for consistent environment setup"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Swift Environment
        id: swift-setup
        uses: ./.github/actions/setup-swift-environment
        with:
          cache-key-suffix: '-build'
          install-swiftlint: 'false'
          setup-test-scripts: 'false'
          validate-environment: 'false'

      - name: ğŸ”¨ Build Project
        run: |
          echo "::group::Project Compilation"
          echo "::notice title=Build Process::Compiling project with Swift Package Manager"
          echo "ğŸ”¨ Building project with Swift Package Manager..."
          echo "ğŸ“Š Status: BUILDING"
          echo "âš™ï¸ Build mode: Debug with verbose output"
          echo "ğŸ”§ Swift version: ${{ steps.swift-setup.outputs.swift-version }}"
          echo "ğŸ’¾ Cache status: ${{ steps.swift-setup.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
          
          # Build with verbose output to capture detailed error information
          if swift build --verbose; then
            echo "::notice title=Build Success::Project compiled successfully"
            echo "âœ… Build completed successfully"
            echo "ğŸ“Š Status: SUCCESS"
            echo "ğŸ¯ All Swift modules compiled without errors"
          else
            echo "::error title=Build Failed::Project compilation failed"
            echo "âŒ Build failed - see detailed error information above"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"

      - name: ğŸ“Š Build Validation Summary
        if: always()
        run: |
          echo "::group::Build Validation Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Build Complete::Build validation completed successfully"
            echo "âœ… Project compilation: PASSED"
            echo "âœ… Dependency resolution: PASSED"
            echo "ğŸ¯ All Swift modules built successfully"
            echo "ğŸ“‹ Build artifacts ready for testing"
            echo "ğŸ”§ Environment: ${{ steps.swift-setup.outputs.swift-version }}"
          else
            echo "::error title=Build Failed::Build validation failed"
            echo "âŒ Project compilation: FAILED"
            echo "ğŸ”§ Action required: Fix build errors before merging"
            echo "ğŸ“‹ Common build issues to check:"
            echo "   â€¢ Missing or incompatible dependencies"
            echo "   â€¢ Swift syntax or compilation errors"
            echo "   â€¢ Import resolution failures"
            echo "   â€¢ Platform compatibility issues"
            echo "   â€¢ Package.swift configuration problems"
          fi
          echo "::endgroup::"

  test-suite:
    name: Test Suite (${{ matrix.environment }})
    runs-on: macos-latest
    needs: [code-quality, build-validation]
    strategy:
      matrix:
        environment: 
          - ${{ inputs.test_environment || 'ci' }}
      fail-fast: false
    outputs:
      result: ${{ steps.test-execution.outputs.result }}
      test-time: ${{ steps.test-execution.outputs.test-time }}
      tests-run: ${{ steps.test-execution.outputs.tests-run }}
      capabilities: ${{ steps.test-execution.outputs.environment-capabilities }}
    steps:
      - name: ğŸ§ª Starting Test Suite Execution
        run: |
          echo "::notice title=Test Suite::Starting comprehensive test suite execution"
          echo "ğŸ§ª Executing ${{ matrix.environment }} test environment using standardized test execution"
          echo "ğŸ“Š Status: STARTING"
          echo "ğŸ¯ Using reusable composite action for consistent test execution"
          echo "âš™ï¸ Environment: ${{ matrix.environment }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Swift Environment
        uses: ./.github/actions/setup-swift-environment
        with:
          cache-key-suffix: '-test-${{ matrix.environment }}'
          install-swiftlint: 'false'
          setup-test-scripts: 'true'
          validate-environment: 'true'

      - name: ğŸ§ª Execute Test Suite
        id: test-execution
        uses: ./.github/actions/run-test-suite
        with:
          test-environment: ${{ matrix.environment }}
          cache-key-suffix: '-${{ matrix.environment }}'
          timeout-seconds: ${{ matrix.environment == 'production' && '600' || '180' }}
          swift-configuration: 'debug'
          parallel-execution: 'true'
          enable-qemu-tests: ${{ inputs.enable_qemu_tests || 'auto' }}
          enable-hardware-tests: ${{ inputs.enable_hardware_tests || 'auto' }}
          enable-system-extension-tests: 'auto'
          skip-build: 'false'
          working-directory: '.'

      - name: ğŸ“Š Test Suite Summary
        if: always()
        run: |
          echo "::group::Test Suite Summary"
          
          RESULT="${{ steps.test-execution.outputs.result }}"
          TEST_TIME="${{ steps.test-execution.outputs.test-time }}"
          TESTS_RUN="${{ steps.test-execution.outputs.tests-run }}"
          CAPABILITIES="${{ steps.test-execution.outputs.capabilities }}"
          
          if [ "$RESULT" = "success" ]; then
            echo "::notice title=Test Suite Complete::${{ matrix.environment }} test suite completed successfully"
            echo "âœ… Test execution: SUCCESS"
            echo "â±ï¸ Duration: ${TEST_TIME}s"
            echo "ğŸ§ª Tests run: $TESTS_RUN"
            echo "ğŸ”§ Capabilities: $CAPABILITIES"
            echo "ğŸ¯ Environment: ${{ matrix.environment }}"
          else
            echo "::error title=Test Suite Failed::${{ matrix.environment }} test suite execution failed"
            echo "âŒ Test execution: $RESULT"
            echo "â±ï¸ Duration: ${TEST_TIME}s"
            echo "ğŸ§ª Tests attempted: $TESTS_RUN"
            echo "ğŸ”§ Action required: Fix failing tests before merging"
          fi
          
          echo "::endgroup::"

  release-validation:
    name: Release Validation
    runs-on: macos-latest
    if: ${{ env.IS_RELEASE_VALIDATION == 'true' }}
    needs: [code-quality, build-validation, test-suite]
    steps:
      - name: ğŸš€ Starting Release Validation
        run: |
          echo "::notice title=Release Validation::Starting release-specific validation checks"
          echo "ğŸš€ Validating release-specific requirements and artifacts for release readiness"
          echo "ğŸ“Š Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Swift Environment
        uses: ./.github/actions/setup-swift-environment
        with:
          cache-key-suffix: '-release'
          install-swiftlint: 'false'
          setup-test-scripts: 'false'
          validate-environment: 'false'

      - name: ğŸ“‹ Verify Release Context
        run: |
          echo "::group::Release Context Information"
          echo "::notice title=Release Context::Analyzing release validation requirements"
          echo "ğŸ·ï¸ Reference: ${{ github.ref }}"
          echo "ğŸ“¦ Event: ${{ github.event_name }}"
          echo "ğŸ” Release validation mode: ${{ env.IS_RELEASE_VALIDATION }}"
          echo "âš¡ Skip optional tests: ${{ env.SKIP_OPTIONAL_TESTS }}"
          echo "ğŸ¯ Test environment: ${{ env.TEST_ENVIRONMENT }}"
          echo "ğŸ“Š Release context status: VERIFIED"
          echo "::endgroup::"

      - name: ğŸ” Validate Release Artifacts
        run: |
          echo "::group::Release Artifact Validation"
          echo "::notice title=Artifact Validation::Validating release artifact integrity"
          echo "ğŸ“¦ Validating release artifact structure and integrity..."
          echo "ğŸ“Š Status: VALIDATING"
          
          # Build for validation
          swift build --verbose
          
          # Validate build products exist
          if [ -d ".build/debug" ]; then
            echo "âœ… Build artifacts present"
            echo "ğŸ“‹ Build products validated"
          else
            echo "âŒ Build artifacts missing"
            exit 1
          fi
          
          echo "::notice title=Artifacts Valid::Release artifacts validated successfully"
          echo "ğŸ“Š Status: VALIDATED"
          echo "::endgroup::"

      - name: ğŸ·ï¸ Validate Version Information
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "::group::Version Information Validation"
          echo "::notice title=Version Validation::Validating release version information"
          echo "ğŸ·ï¸ Validating version tag and release information..."
          echo "ğŸ“Š Status: VALIDATING"
          
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "ğŸ·ï¸ Release version: $VERSION"
          
          # Validate version format (semantic versioning)
          if [[ $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âœ… Version format valid: $VERSION"
            echo "::notice title=Version Valid::Release version format validated"
          else
            echo "âŒ Invalid version format: $VERSION"
            echo "::error title=Version Invalid::Release version format validation failed"
            exit 1
          fi
          
          echo "ğŸ“Š Status: VALIDATED"
          echo "::endgroup::"

      - name: ğŸ“Š Release Validation Summary
        if: always()
        run: |
          echo "::group::Release Validation Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Release Validation Complete::All release validation checks passed"
            echo "âœ… Release artifact validation: PASSED"
            echo "âœ… Version information validation: PASSED"
            echo "ğŸ¯ Release requirements validated successfully"
            echo "ğŸ“‹ Ready for release pipeline execution"
          else
            echo "::error title=Release Validation Failed::Release validation checks failed"
            echo "âŒ Release validation: FAILED"
            echo "ğŸ”§ Action required: Fix release validation issues before proceeding"
          fi
          echo "::endgroup::"

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, build-validation, test-suite, release-validation]
    outputs:
      success: ${{ steps.check-status.outputs.success }}
      release_ready: ${{ steps.check-status.outputs.release_ready }}
      test_environment: ${{ env.TEST_ENVIRONMENT }}
    steps:
      - name: ğŸ“Š Check Overall CI Status
        id: check-status
        run: |
          echo "::group::CI Status Analysis"
          echo "::notice title=CI Summary::Analyzing overall consolidated CI execution status"
          
          # Check job statuses
          CODE_QUALITY_STATUS="${{ needs.code-quality.result }}"
          BUILD_STATUS="${{ needs.build-validation.result }}"
          TEST_STATUS="${{ needs.test-suite.result }}"
          RELEASE_VAL_STATUS="${{ needs.release-validation.result }}"
          
          echo "ğŸ“‹ Job status summary:"
          echo "   â€¢ Code Quality: $CODE_QUALITY_STATUS"
          echo "   â€¢ Build Validation: $BUILD_STATUS"
          echo "   â€¢ Test Suite (${{ env.TEST_ENVIRONMENT }}): $TEST_STATUS"
          echo "   â€¢ Release Validation: $RELEASE_VAL_STATUS"
          
          # Determine overall success
          REQUIRED_SUCCESS=true
          RELEASE_READY=false
          
          # Check required jobs (code quality, build, tests)
          if [[ "$CODE_QUALITY_STATUS" != "success" || "$BUILD_STATUS" != "success" ]]; then
            REQUIRED_SUCCESS=false
          fi
          
          # Check test status (required unless explicitly skipped)
          if [[ "$TEST_STATUS" != "success" && "$TEST_STATUS" != "skipped" ]]; then
            if [[ "${{ env.SKIP_OPTIONAL_TESTS }}" != "true" ]]; then
              REQUIRED_SUCCESS=false
            fi
          fi
          
          # For release validation, check if release validation passed
          if [[ "${{ env.IS_RELEASE_VALIDATION }}" == "true" ]]; then
            if [[ "$RELEASE_VAL_STATUS" == "success" ]]; then
              RELEASE_READY=true
              echo "ğŸš€ Release validation: PASSED"
            else
              RELEASE_READY=false
              echo "âŒ Release validation: FAILED"
              if [[ "$RELEASE_VAL_STATUS" != "skipped" ]]; then
                REQUIRED_SUCCESS=false
              fi
            fi
          fi
          
          # Set outputs
          echo "success=$REQUIRED_SUCCESS" >> $GITHUB_OUTPUT
          echo "release_ready=$RELEASE_READY" >> $GITHUB_OUTPUT
          
          if [[ "$REQUIRED_SUCCESS" == "true" ]]; then
            echo "::notice title=CI Success::All required consolidated CI checks passed successfully"
            echo "âœ… Overall CI status: SUCCESS"
            echo "ğŸ¯ Test environment: ${{ env.TEST_ENVIRONMENT }}"
            echo "ğŸ“‹ Consolidated workflow execution: COMPLETE"
          else
            echo "::error title=CI Failed::One or more required consolidated CI checks failed"
            echo "âŒ Overall CI status: FAILED"
            echo "ğŸ”§ Review job details above for specific failure information"
          fi
          
          if [[ "$RELEASE_READY" == "true" ]]; then
            echo "::notice title=Release Ready::Consolidated CI validation complete - ready for release"
            echo "ğŸš€ Release readiness: READY"
          fi
          
          echo "::endgroup::"
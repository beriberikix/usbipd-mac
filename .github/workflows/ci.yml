name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Global environment variables for consistent status reporting
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  lint:
    name: Code Quality (SwiftLint)
    runs-on: macos-latest
    steps:
      - name: ğŸ“‹ Starting Code Quality Check
        run: |
          echo "::notice title=Code Quality Check::Starting SwiftLint validation for code quality and style compliance"
          echo "ğŸ” This check validates Swift code against project style guidelines"
          echo "ğŸ“Š Status: STARTING"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cache SwiftLint
        uses: actions/cache@v3
        with:
          path: |
            /usr/local/bin/swiftlint
            /opt/homebrew/bin/swiftlint
          key: ${{ runner.os }}-swiftlint-${{ hashFiles('.swiftlint.yml') }}
          restore-keys: |
            ${{ runner.os }}-swiftlint-
      
      - name: ğŸ”§ Install SwiftLint
        run: |
          echo "::group::SwiftLint Installation"
          echo "ğŸ“¦ Checking SwiftLint installation status..."
          # Check if SwiftLint is already installed
          if ! command -v swiftlint &> /dev/null; then
            echo "::notice title=SwiftLint Installation::Installing SwiftLint via Homebrew"
            echo "â¬‡ï¸ SwiftLint not found, installing via Homebrew..."
            brew install swiftlint
            echo "âœ… SwiftLint installation completed"
          else
            echo "::notice title=SwiftLint Found::Using cached SwiftLint installation"
            echo "âœ… SwiftLint is already installed"
            echo "ğŸ“‹ Version: $(swiftlint version)"
          fi
          echo "::endgroup::"
      
      - name: ğŸ” Run SwiftLint Analysis
        run: |
          echo "::group::SwiftLint Analysis"
          echo "::notice title=Code Analysis::Running SwiftLint with strict validation"
          echo "ğŸ” Analyzing Swift code for style violations..."
          echo "ğŸ“Š Status: RUNNING"
          echo "âš™ï¸ Configuration: Using .swiftlint.yml rules"
          echo "ğŸ¯ Mode: Strict (warnings treated as errors)"
          
          # Use --strict to fail on warnings, --reporter xcode for detailed output
          if swiftlint lint --strict --reporter xcode; then
            echo "::notice title=SwiftLint Success::No code style violations found"
            echo "âœ… Code quality check PASSED"
            echo "ğŸ“Š Status: SUCCESS"
          else
            echo "::error title=SwiftLint Violations::Code style violations detected"
            echo "âŒ Code quality check FAILED"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: false
      
      - name: ğŸ“Š Code Quality Summary
        if: always()
        run: |
          echo "::group::Code Quality Check Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Code Quality Complete::All code quality checks passed successfully"
            echo "âœ… SwiftLint validation: PASSED"
            echo "ğŸ“‹ No style violations found"
            echo "ğŸ¯ Code meets project quality standards"
          else
            echo "::error title=Code Quality Failed::Code quality checks failed"
            echo "âŒ SwiftLint validation: FAILED"
            echo "ğŸ“‹ Style violations detected - see details above"
            echo "ğŸ”§ Action required: Fix code style issues before merging"
          fi
          echo "::endgroup::"

  build:
    name: Build Validation
    runs-on: macos-latest
    steps:
      - name: ğŸ—ï¸ Starting Build Validation
        run: |
          echo "::notice title=Build Validation::Starting project compilation and build validation"
          echo "ğŸ”¨ This check validates that the project compiles successfully"
          echo "ğŸ“Š Status: STARTING"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Verify Build Environment
        run: |
          echo "::group::Build Environment Information"
          echo "::notice title=Environment Setup::Verifying Swift and macOS environment"
          echo "ğŸ”§ Swift version: $(swift --version | head -n1)"
          echo "ğŸ–¥ï¸ macOS runner: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "ğŸ“Š Environment status: READY"
          echo "::endgroup::"
      
      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/org.swift.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-
      
      - name: ğŸ“¦ Resolve Dependencies
        run: |
          echo "::group::Dependency Resolution"
          echo "::notice title=Dependencies::Resolving Swift package dependencies"
          echo "ğŸ“¦ Resolving Swift package dependencies..."
          echo "ğŸ“Š Status: RESOLVING"
          
          if swift package resolve; then
            echo "::notice title=Dependencies Success::All dependencies resolved successfully"
            echo "âœ… Dependencies resolved successfully"
            echo "ğŸ“Š Status: RESOLVED"
          else
            echo "::error title=Dependencies Failed::Failed to resolve package dependencies"
            echo "âŒ Dependency resolution failed"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: ğŸ”¨ Build Project
        run: |
          echo "::group::Project Compilation"
          echo "::notice title=Build Process::Compiling project with Swift Package Manager"
          echo "ğŸ”¨ Building project with Swift Package Manager..."
          echo "ğŸ“Š Status: BUILDING"
          echo "âš™ï¸ Build mode: Debug with verbose output"
          
          # Build with verbose output to capture detailed error information
          if swift build --verbose; then
            echo "::notice title=Build Success::Project compiled successfully"
            echo "âœ… Build completed successfully"
            echo "ğŸ“Š Status: SUCCESS"
            echo "ğŸ¯ All Swift modules compiled without errors"
          else
            echo "::error title=Build Failed::Project compilation failed"
            echo "âŒ Build failed - see detailed error information above"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: false
      
      - name: ğŸ“Š Build Validation Summary
        if: always()
        run: |
          echo "::group::Build Validation Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Build Complete::Build validation completed successfully"
            echo "âœ… Project compilation: PASSED"
            echo "âœ… Dependency resolution: PASSED"
            echo "ğŸ¯ All Swift modules built successfully"
            echo "ğŸ“‹ Build artifacts ready for testing"
          else
            echo "::error title=Build Failed::Build validation failed"
            echo "âŒ Project compilation: FAILED"
            echo "ğŸ”§ Action required: Fix build errors before merging"
            echo "ğŸ“‹ Common build issues to check:"
            echo "   â€¢ Missing or incompatible dependencies"
            echo "   â€¢ Swift syntax or compilation errors"
            echo "   â€¢ Import resolution failures"
            echo "   â€¢ Platform compatibility issues"
            echo "   â€¢ Package.swift configuration problems"
          fi
          echo "::endgroup::"

  test:
    name: Unit Tests
    runs-on: macos-latest
    steps:
      - name: ğŸ§ª Starting Unit Test Execution
        run: |
          echo "::notice title=Unit Tests::Starting comprehensive unit test execution"
          echo "ğŸ§ª This check validates functionality through automated unit tests"
          echo "ğŸ“Š Status: STARTING"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Verify Test Environment
        run: |
          echo "::group::Test Environment Information"
          echo "::notice title=Test Environment::Verifying Swift and macOS test environment"
          echo "ğŸ”§ Swift version: $(swift --version | head -n1)"
          echo "ğŸ–¥ï¸ macOS runner: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "ğŸ“Š Test environment status: READY"
          echo "::endgroup::"
      
      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/org.swift.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-
      
      - name: ğŸ“¦ Resolve Test Dependencies
        run: |
          echo "::group::Test Dependency Resolution"
          echo "::notice title=Test Dependencies::Resolving dependencies for test execution"
          echo "ğŸ“¦ Resolving Swift package dependencies for testing..."
          echo "ğŸ“Š Status: RESOLVING"
          
          if swift package resolve; then
            echo "::notice title=Dependencies Success::Test dependencies resolved successfully"
            echo "âœ… Dependencies resolved successfully"
            echo "ğŸ“Š Status: RESOLVED"
          else
            echo "::error title=Dependencies Failed::Failed to resolve test dependencies"
            echo "âŒ Test dependency resolution failed"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: ğŸ§ª Execute Unit Tests
        run: |
          echo "::group::Unit Test Execution"
          echo "::notice title=Test Execution::Running comprehensive unit test suite"
          echo "ğŸ§ª Running unit tests with Swift Package Manager..."
          echo "ğŸ“Š Status: TESTING"
          echo "âš™ï¸ Test mode: Parallel execution with verbose output"
          echo "ğŸ¯ Test suites to execute:"
          echo "   â€¢ USBIPDCoreTests - Core functionality validation"
          echo "   â€¢ USBIPDCLITests - Command-line interface validation"
          
          # Run tests with verbose output and proper error reporting
          if swift test --verbose --parallel; then
            echo "::notice title=Tests Success::All unit tests passed successfully"
            echo "âœ… Unit tests completed successfully"
            echo "ğŸ“Š Status: SUCCESS"
          else
            echo "::error title=Tests Failed::Unit test execution failed"
            echo "âŒ Unit tests failed - see detailed failure information above"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: false
      
      - name: ğŸ“Š Unit Test Summary
        if: always()
        run: |
          echo "::group::Unit Test Execution Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Tests Complete::Unit test execution completed successfully"
            echo "âœ… All unit tests: PASSED"
            echo "ğŸ¯ Test suites executed successfully:"
            echo "   â€¢ USBIPDCoreTests - Core functionality validation"
            echo "   â€¢ USBIPDCLITests - Command-line interface validation"
            echo "ğŸ“‹ All functionality validated through automated tests"
          else
            echo "::error title=Tests Failed::Unit test execution failed"
            echo "âŒ Unit test execution: FAILED"
            echo "ğŸ”§ Action required: Fix failing tests before merging"
            echo "ğŸ“‹ Common test failure causes:"
            echo "   â€¢ Assertion failures in test cases"
            echo "   â€¢ Runtime errors during test execution"
            echo "   â€¢ Missing test dependencies or setup"
            echo "   â€¢ Platform-specific test compatibility issues"
            echo "   â€¢ Test data or mock configuration problems"
          fi
          echo "::endgroup::"

  integration-test:
    name: Integration Tests (QEMU)
    runs-on: macos-latest
    steps:
      - name: ğŸ”— Starting Integration Test Execution
        run: |
          echo "::notice title=Integration Tests::Starting end-to-end integration test validation"
          echo "ğŸ”— This check validates complete system functionality with QEMU test server"
          echo "ğŸ“Š Status: STARTING"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Verify Integration Test Environment
        run: |
          echo "::group::Integration Test Environment Information"
          echo "::notice title=Integration Environment::Verifying Swift and macOS integration test environment"
          echo "ğŸ”§ Swift version: $(swift --version | head -n1)"
          echo "ğŸ–¥ï¸ macOS runner: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "ğŸ“Š Integration test environment status: READY"
          echo "::endgroup::"
      
      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/org.swift.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-
      
      - name: ğŸ”§ Setup Integration Test Dependencies
        run: |
          echo "::group::Integration Test Setup"
          echo "::notice title=Test Setup::Configuring integration test dependencies"
          echo "ğŸ”§ Setting up integration test dependencies..."
          echo "ğŸ“Š Status: CONFIGURING"
          
          # Ensure Scripts directory is executable
          chmod +x Scripts/run-qemu-tests.sh
          echo "âœ… Test script permissions configured"
          echo "ğŸ“Š Status: CONFIGURED"
          echo "::endgroup::"
      
      - name: ğŸ“¦ Resolve Integration Dependencies
        run: |
          echo "::group::Integration Dependency Resolution"
          echo "::notice title=Integration Dependencies::Resolving dependencies for integration testing"
          echo "ğŸ“¦ Resolving Swift package dependencies for integration testing..."
          echo "ğŸ“Š Status: RESOLVING"
          
          if swift package resolve; then
            echo "::notice title=Dependencies Success::Integration dependencies resolved successfully"
            echo "âœ… Dependencies resolved successfully"
            echo "ğŸ“Š Status: RESOLVED"
          else
            echo "::error title=Dependencies Failed::Failed to resolve integration dependencies"
            echo "âŒ Integration dependency resolution failed"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: ğŸ—ï¸ Build QEMU Test Server
        run: |
          echo "::group::QEMU Test Server Build"
          echo "::notice title=QEMU Build::Building QEMU test server for integration testing"
          echo "ğŸ—ï¸ Building QEMU test server..."
          echo "ğŸ“Š Status: BUILDING"
          
          if swift build --product QEMUTestServer; then
            echo "::notice title=QEMU Build Success::QEMU test server built successfully"
            echo "âœ… QEMU test server built successfully"
            echo "ğŸ“Š Status: BUILT"
          else
            echo "::error title=QEMU Build Failed::Failed to build QEMU test server"
            echo "âŒ QEMU test server build failed"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: ğŸ§ª Run QEMU Test Script Validation
        run: |
          echo "::group::QEMU Script Validation"
          echo "::notice title=QEMU Validation::Running QEMU test server validation script"
          echo "ğŸ§ª Running QEMU test server validation script..."
          echo "ğŸ“Š Status: VALIDATING"
          
          if ./Scripts/run-qemu-tests.sh; then
            echo "::notice title=QEMU Validation Success::QEMU test script validation completed successfully"
            echo "âœ… QEMU test script validation completed"
            echo "ğŸ“Š Status: VALIDATED"
          else
            echo "::error title=QEMU Validation Failed::QEMU test script validation failed"
            echo "âŒ QEMU test script validation failed"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: false
      
      - name: ğŸ”— Execute Integration Tests
        run: |
          echo "::group::Integration Test Execution"
          echo "::notice title=Integration Execution::Running end-to-end integration tests"
          echo "ğŸ”— Running integration tests with QEMU test server..."
          echo "ğŸ“Š Status: TESTING"
          echo "âš™ï¸ Test mode: Integration tests with verbose output"
          echo "ğŸ¯ Integration test components:"
          echo "   â€¢ QEMU test server functionality"
          echo "   â€¢ End-to-end protocol flow validation"
          echo "   â€¢ Network communication layer testing"
          
          # Run only the integration tests
          if swift test --filter IntegrationTests --verbose; then
            echo "::notice title=Integration Success::Integration tests completed successfully"
            echo "âœ… Integration tests completed successfully"
            echo "ğŸ“Š Status: SUCCESS"
          else
            echo "::error title=Integration Failed::Integration test execution failed"
            echo "âŒ Integration tests failed - see detailed failure information above"
            echo "ğŸ“Š Status: FAILED"
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: false
      
      - name: ğŸ“Š Integration Test Summary
        if: always()
        run: |
          echo "::group::Integration Test Execution Summary"
          if [ ${{ job.status }} == 'success' ]; then
            echo "::notice title=Integration Complete::Integration test execution completed successfully"
            echo "âœ… All integration tests: PASSED"
            echo "âœ… QEMU test server: VALIDATED"
            echo "ğŸ¯ Integration test components validated:"
            echo "   â€¢ QEMU test server functionality"
            echo "   â€¢ End-to-end protocol flow validation"
            echo "   â€¢ Network communication layer testing"
            echo "   â€¢ System integration and compatibility"
            echo "ğŸ“‹ Complete system functionality validated"
          else
            echo "::error title=Integration Failed::Integration test execution failed"
            echo "âŒ Integration test execution: FAILED"
            echo "ğŸ”§ Action required: Fix integration issues before merging"
            echo "ğŸ“‹ Common integration test failure causes:"
            echo "   â€¢ QEMU test server setup or configuration issues"
            echo "   â€¢ Network connectivity or communication problems"
            echo "   â€¢ USB/IP protocol compatibility issues"
            echo "   â€¢ Test environment configuration problems"
            echo "   â€¢ System-level integration failures"
            echo "   â€¢ Resource availability or timing issues"
          fi
          echo "::endgroup::"
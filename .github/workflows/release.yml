name: Production Release (Streamlined)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip test validation (emergency use only)'
        required: false
        default: false
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEVELOPER_ID_CERTIFICATE: ${{ secrets.DEVELOPER_ID_CERTIFICATE }}
  DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
  NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
  NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}

jobs:
  release-validation:
    name: Release Validation
    runs-on: macos-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is-prerelease: ${{ steps.extract-version.outputs.prerelease }}
      release-type: ${{ steps.extract-version.outputs.release-type }}
    steps:
      - name: üè∑Ô∏è Starting Release Validation
        run: |
          echo "::notice title=Release Validation::Starting streamlined release validation and version extraction"
          echo "üè∑Ô∏è This stage validates release triggers and extracts necessary metadata"
          echo "üìä Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Extract Version Information
        id: extract-version
        run: |
          echo "::group::Version Extraction"
          echo "::notice title=Version Processing::Extracting and validating version information"
          
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION=${{ github.ref_name }}
            echo "üìå Tag-triggered release: $VERSION"
            PRERELEASE=$(echo "$VERSION" | grep -E '-(alpha|beta|rc)' >/dev/null && echo "true" || echo "false")
            RELEASE_TYPE="automated"
          else
            VERSION="${{ github.event.inputs.version }}"
            PRERELEASE="${{ github.event.inputs.prerelease }}"
            RELEASE_TYPE="manual"
            echo "üîß Manual release dispatch: $VERSION"
          fi
          
          # Validate semantic versioning
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error title=Invalid Version::Version must follow semantic versioning (vX.Y.Z or vX.Y.Z-suffix)"
            exit 1
          fi
          
          echo "‚úÖ Version validated: $VERSION"
          echo "üè∑Ô∏è Pre-release: $PRERELEASE"
          echo "üîß Release type: $RELEASE_TYPE"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "release-type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üìä Release Validation Summary
        run: |
          echo "::group::Release Validation Summary"
          echo "::notice title=Release Validated::Release version and trigger validated successfully"
          echo "‚úÖ Release trigger: ${{ github.event_name }}"
          echo "‚úÖ Version: ${{ steps.extract-version.outputs.version }}"
          echo "‚úÖ Pre-release: ${{ steps.extract-version.outputs.prerelease }}"
          echo "‚úÖ Release type: ${{ steps.extract-version.outputs.release-type }}"
          echo "üìä Status: VALIDATED"
          echo "::endgroup::"

  ci-validation:
    name: CI Validation
    needs: release-validation
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/ci.yml
    with:
      release_validation: true
      test_environment: 'ci'
      enable_qemu_tests: false
    secrets: inherit

  build-artifacts:
    name: Build Release Artifacts
    runs-on: macos-latest
    needs: [release-validation, ci-validation]
    if: always() && needs.release-validation.result == 'success' && (needs.ci-validation.result == 'success' || needs.ci-validation.result == 'skipped')
    outputs:
      artifact-paths: ${{ steps.build-artifacts.outputs.paths }}
      checksums: ${{ steps.generate-checksums.outputs.checksums }}
    steps:
      - name: üì¶ Starting Artifact Building
        run: |
          echo "::notice title=Artifact Building::Starting streamlined release artifact building and packaging"
          echo "üì¶ This stage builds and packages release artifacts with code signing"
          echo "üìä Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Swift Environment
        uses: ./.github/actions/setup-swift-environment
        with:
          cache-key-suffix: '-release'
          install-swiftlint: 'false'
          setup-test-scripts: 'false'
          validate-environment: 'false'

      - name: üîí Setup Code Signing
        if: env.DEVELOPER_ID_CERTIFICATE != ''
        run: |
          echo "::group::Code Signing Setup"
          echo "::notice title=Code Signing::Setting up Apple Developer certificates for release signing"
          
          # Import Developer ID certificate
          echo "$DEVELOPER_ID_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$DEVELOPER_ID_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm certificate.p12
          
          echo "::notice title=Signing Ready::Code signing environment configured"
          echo "‚úÖ Code signing ready"
          echo "::endgroup::"

      - name: üèóÔ∏è Build Release Artifacts
        id: build-artifacts
        run: |
          echo "::group::Release Artifact Building"
          echo "::notice title=Artifact Building::Building optimized release artifacts"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          ARTIFACTS_DIR="release-artifacts"
          mkdir -p "$ARTIFACTS_DIR"
          
          echo "üèóÔ∏è Building release artifacts for $VERSION..."
          
          # Build optimized release binaries
          swift build --configuration release --arch arm64 --arch x86_64
          
          # Package main executable
          USBIPD_PATH="$ARTIFACTS_DIR/usbipd-$VERSION-macos"
          cp .build/release/usbipd "$USBIPD_PATH"
          
          # Package QEMU test server if available
          if [ -f .build/release/QEMUTestServer ]; then
            QEMU_SERVER_PATH="$ARTIFACTS_DIR/QEMUTestServer-$VERSION-macos"
            cp .build/release/QEMUTestServer "$QEMU_SERVER_PATH"
          fi
          
          # Code sign binaries if certificates available
          if [ -n "$DEVELOPER_ID_CERTIFICATE" ]; then
            echo "üîí Code signing release artifacts..."
            codesign --sign "Developer ID Application" --timestamp "$USBIPD_PATH" || echo "::warning::Code signing failed for usbipd"
            if [ -f "$QEMU_SERVER_PATH" ]; then
              codesign --sign "Developer ID Application" --timestamp "$QEMU_SERVER_PATH" || echo "::warning::Code signing failed for QEMUTestServer"
            fi
            echo "‚úÖ Code signing completed"
          else
            echo "::warning::No code signing certificates available - binaries will be unsigned"
          fi
          
          # Create archive
          ARCHIVE_PATH="$ARTIFACTS_DIR/usbipd-mac-$VERSION.tar.gz"
          tar -czf "$ARCHIVE_PATH" -C "$ARTIFACTS_DIR" $(ls "$ARTIFACTS_DIR" | grep -v ".tar.gz")
          
          # Output artifact paths
          PATHS="$USBIPD_PATH"
          if [ -f "$QEMU_SERVER_PATH" ]; then
            PATHS="$PATHS,$QEMU_SERVER_PATH"
          fi
          PATHS="$PATHS,$ARCHIVE_PATH"
          
          echo "paths=$PATHS" >> $GITHUB_OUTPUT
          echo "::notice title=Artifacts Built::Release artifacts built successfully"
          echo "‚úÖ Artifacts: $PATHS"
          echo "::endgroup::"

      - name: üìä Generate Checksums
        id: generate-checksums
        run: |
          echo "::group::Checksum Generation"
          echo "::notice title=Checksums::Generating SHA256 checksums for release artifacts"
          
          cd release-artifacts
          CHECKSUMS_FILE="checksums-${{ needs.release-validation.outputs.version }}.sha256"
          
          echo "üìä Generating checksums..."
          shasum -a 256 * > "$CHECKSUMS_FILE"
          
          echo "::notice title=Checksums Generated::SHA256 checksums created for all artifacts"
          echo "‚úÖ Checksums saved to $CHECKSUMS_FILE"
          
          echo "checksums=$CHECKSUMS_FILE" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üì§ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.release-validation.outputs.version }}
          path: release-artifacts/
          retention-days: 30

  update-homebrew-formula:
    name: Update Homebrew Formula
    runs-on: macos-latest
    needs: [release-validation, build-artifacts]
    steps:
      - name: üç∫ Starting Homebrew Formula Update
        run: |
          echo "::notice title=Homebrew Formula::Starting automated Homebrew formula update"
          echo "üç∫ This stage updates the formula with release version and checksum"
          echo "üìä Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üì§ Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.release-validation.outputs.version }}
          path: release-artifacts/

      - name: üî¢ Calculate Archive SHA256
        id: calculate-sha256
        run: |
          echo "::group::SHA256 Calculation"
          echo "::notice title=SHA256::Calculating GitHub source archive checksum for formula update"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          ARCHIVE_URL="https://github.com/beriberikix/usbipd-mac/archive/$VERSION.tar.gz"
          
          echo "üìä Downloading and calculating SHA256 for GitHub source archive..."
          echo "   URL: $ARCHIVE_URL"
          
          # Download and calculate SHA256 of the GitHub source archive
          SHA256_CHECKSUM=$(curl -sL "$ARCHIVE_URL" | shasum -a 256 | cut -d' ' -f1)
          
          if [[ ! "$SHA256_CHECKSUM" =~ ^[a-fA-F0-9]{64}$ ]]; then
            echo "::error title=Invalid Checksum::Generated checksum format is invalid"
            exit 1
          fi
          
          echo "‚úÖ SHA256 calculated: $SHA256_CHECKSUM"
          echo "   This matches what Homebrew will download from GitHub"
          echo "sha256=$SHA256_CHECKSUM" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üç∫ Update Formula
        run: |
          echo "::group::Formula Update"
          echo "::notice title=Formula Update::Updating Homebrew formula with release information"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          SHA256_CHECKSUM="${{ steps.calculate-sha256.outputs.sha256 }}"
          
          echo "üç∫ Updating formula..."
          echo "   Version: $VERSION"
          echo "   SHA256: $SHA256_CHECKSUM"
          
          # Use the formula update script
          ./Scripts/update-formula.sh \
            --version "$VERSION" \
            --checksum "$SHA256_CHECKSUM" \
            --skip-validation \
            --no-tag-validation
          
          echo "::notice title=Formula Updated::Formula placeholders updated successfully"
          echo "‚úÖ Formula updated with release information"
          echo "::endgroup::"

      - name: üîç Validate Updated Formula
        run: |
          echo "::group::Formula Validation"
          echo "::notice title=Formula Validation::Validating updated formula syntax and structure"
          
          # Check Ruby syntax
          if ruby -c Formula/usbipd-mac.rb >/dev/null 2>&1; then
            echo "‚úÖ Ruby syntax validation passed"
          else
            echo "::error title=Syntax Error::Formula has Ruby syntax errors"
            ruby -c Formula/usbipd-mac.rb
            exit 1
          fi
          
          # Verify placeholders were replaced
          if grep -q "VERSION_PLACEHOLDER\|SHA256_PLACEHOLDER" Formula/usbipd-mac.rb; then
            echo "::error title=Placeholder Error::Formula still contains unreplaced placeholders"
            grep -n "VERSION_PLACEHOLDER\|SHA256_PLACEHOLDER" Formula/usbipd-mac.rb
            exit 1
          fi
          
          # Verify new values are present
          VERSION="${{ needs.release-validation.outputs.version }}"
          SHA256_CHECKSUM="${{ steps.calculate-sha256.outputs.sha256 }}"
          
          if ! grep -q "$VERSION" Formula/usbipd-mac.rb; then
            echo "::error title=Version Missing::Version $VERSION not found in updated formula"
            exit 1
          fi
          
          if ! grep -q "$SHA256_CHECKSUM" Formula/usbipd-mac.rb; then
            echo "::error title=Checksum Missing::SHA256 checksum not found in updated formula"
            exit 1
          fi
          
          echo "::notice title=Formula Validated::Updated formula passed all validation checks"
          echo "‚úÖ Formula validation completed successfully"
          echo "::endgroup::"

      - name: üìÑ Commit Formula Changes
        run: |
          echo "::group::Formula Commit"
          echo "::notice title=Formula Commit::Committing updated formula to repository"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          SHA256_CHECKSUM="${{ steps.calculate-sha256.outputs.sha256 }}"
          
          # Configure Git for the GitHub Actions bot
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes to commit
          if git diff --quiet Formula/usbipd-mac.rb; then
            echo "::warning title=No Changes::No changes detected in formula file"
            echo "‚ö†Ô∏è No formula changes to commit"
          else
            # Add and commit the formula changes
            git add Formula/usbipd-mac.rb
            
            git commit -m "feat: update Homebrew formula to $VERSION - automated release workflow update"
            
            echo "::notice title=Formula Committed::Formula changes committed successfully"
            echo "‚úÖ Formula changes committed"
            echo "üìã Commit message: feat: update Homebrew formula to $VERSION"
          fi
          echo "::endgroup::"

      - name: üì§ Push Formula Changes
        run: |
          echo "::group::Formula Push"
          echo "::notice title=Formula Push::Pushing updated formula to repository"
          
          # Push the changes to main branch (release runs on tag, so HEAD is detached)
          git push origin HEAD:main
          
          echo "::notice title=Formula Pushed::Updated formula pushed to repository"
          echo "‚úÖ Formula changes pushed to repository"
          echo "üîó Formula updated in main branch"
          echo "::endgroup::"

  create-release:
    name: Create GitHub Release
    runs-on: macos-latest
    needs: [release-validation, build-artifacts, update-homebrew-formula]
    steps:
      - name: üöÄ Starting Release Creation
        run: |
          echo "::notice title=Release Creation::Creating GitHub release with artifacts"
          echo "üöÄ This stage creates the GitHub release and uploads artifacts"
          echo "üìä Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì§ Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.release-validation.outputs.version }}
          path: release-artifacts/

      - name: üìù Generate Release Notes
        id: release-notes
        run: |
          echo "::group::Release Notes Generation"
          echo "::notice title=Release Notes::Generating release notes from commit history"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "üìù Generating release notes for $VERSION..."
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "üìã Changes since $PREVIOUS_TAG:"
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20)
          else
            echo "üìã Initial release changes:"
            CHANGELOG=$(git log --pretty=format:"- %s" HEAD | head -20)
          fi
          
          # Create release notes
          cat > release-notes.md << EOF
          # Release $VERSION
          
          ## What's Changed
          
          $CHANGELOG
          
          ## Artifacts
          
          This release includes the following artifacts:
          - **usbipd**: Main USB/IP daemon executable for macOS
          - **QEMUTestServer**: QEMU integration test server (if available)
          - **Archive**: Complete packaged release (tar.gz)
          - **Checksums**: SHA256 verification checksums
          
          ## Installation
          
          Download the appropriate binary for your system and verify with the provided checksums.
          
          ## Requirements
          
          - macOS 11.0 or later
          - Administrator privileges for USB device access
          
          **Note**: Binaries are code-signed with Apple Developer ID when available.
          EOF
          
          echo "::notice title=Release Notes Ready::Release notes generated successfully"
          echo "‚úÖ Release notes prepared"
          echo "::endgroup::"

      - name: üöÄ Create GitHub Release
        run: |
          echo "::group::GitHub Release Creation"
          echo "::notice title=GitHub Release::Creating GitHub release with artifacts"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          PRERELEASE="${{ needs.release-validation.outputs.is-prerelease }}"
          
          echo "üöÄ Creating GitHub release $VERSION..."
          
          # Create release
          if [ "$PRERELEASE" = "true" ]; then
            echo "üè∑Ô∏è Creating pre-release"
            gh release create "$VERSION" release-artifacts/* \
              --title "usbipd-mac $VERSION" \
              --notes-file release-notes.md \
              --prerelease
          else
            echo "üè∑Ô∏è Creating stable release"
            gh release create "$VERSION" release-artifacts/* \
              --title "usbipd-mac $VERSION" \
              --notes-file release-notes.md
          fi
          
          echo "::notice title=Release Created::GitHub release created successfully"
          echo "‚úÖ Release $VERSION published"
          echo "üîó Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/$VERSION"
          echo "::endgroup::"

  post-release:
    name: Post-Release Validation
    runs-on: macos-latest
    needs: [release-validation, create-release, update-homebrew-formula]
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: üìä Starting Post-Release Validation
        run: |
          echo "::notice title=Post-Release::Starting post-release validation and summary"
          echo "üìä This stage validates the published release and provides completion summary"
          echo "üìä Status: STARTING"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ‚úÖ Validate Release
        run: |
          echo "::group::Release Validation"
          echo "::notice title=Release Validation::Validating published release"
          
          VERSION="${{ needs.release-validation.outputs.version }}"
          echo "‚úÖ Validating release $VERSION..."
          
          # Verify release exists and is accessible
          if gh release view "$VERSION" > /dev/null 2>&1; then
            echo "::notice title=Release Verified::Release is publicly accessible"
            echo "‚úÖ Release $VERSION verified"
            
            # Display release summary
            echo "üìä Release Summary:"
            echo "   ‚Ä¢ Version: $VERSION"
            echo "   ‚Ä¢ Pre-release: ${{ needs.release-validation.outputs.is-prerelease }}"
            echo "   ‚Ä¢ Release type: ${{ needs.release-validation.outputs.release-type }}"
            echo "   ‚Ä¢ Artifacts: Available"
            echo "   ‚Ä¢ Status: Published"
          else
            echo "::error title=Release Verification Failed::Cannot verify release accessibility"
            echo "‚ùå Release verification failed"
            exit 1
          fi
          echo "::endgroup::"

      - name: üéâ Release Success Summary
        run: |
          echo "::group::Release Success"
          echo "::notice title=Release Complete::Streamlined production release completed successfully"
          echo "üéâ Release ${{ needs.release-validation.outputs.version }} has been successfully published!"
          echo ""
          echo "üì¶ **Release Details:**"
          echo "   ‚Ä¢ Version: ${{ needs.release-validation.outputs.version }}"
          echo "   ‚Ä¢ Pre-release: ${{ needs.release-validation.outputs.is-prerelease }}"
          echo "   ‚Ä¢ Release type: ${{ needs.release-validation.outputs.release-type }}"
          echo "   ‚Ä¢ Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.release-validation.outputs.version }}"
          echo ""
          echo "‚úÖ **Completed Steps:**"
          echo "   ‚Ä¢ Release version validation"
          echo "   ‚Ä¢ Comprehensive CI validation (via workflow_call)"
          echo "   ‚Ä¢ Optimized artifact building and signing"
          echo "   ‚Ä¢ Automated Homebrew formula update"
          echo "   ‚Ä¢ GitHub release creation with artifacts"
          echo "   ‚Ä¢ Post-release verification"
          echo ""
          echo "üîó **Workflow Benefits:**"
          echo "   ‚Ä¢ Reused CI validation logic from consolidated workflow"
          echo "   ‚Ä¢ Streamlined artifact building process"
          echo "   ‚Ä¢ Consistent validation across CI and release pipelines"
          echo "   ‚Ä¢ Reduced workflow duplication and maintenance"
          echo ""
          echo "üìä Status: **SUCCESS**"
          echo "::endgroup::"